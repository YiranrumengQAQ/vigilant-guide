<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>晨雾山谷 · 心灵栖息地</title>
    <meta name="description" content="一处宁静的山谷，晨雾缭绕，湖面如镜，微风轻拂。只为片刻的安宁。">
    <style>
        /* ====================== 响应式全局 ====================== */
        *, *::before, *::after { margin:0; padding:0; box-sizing:border-box; }
        body, html { 
            height:100%; overflow:hidden; font-family:"Segoe UI", "Noto Sans SC", "Microsoft YaHei", sans-serif; 
            background:#000; touch-action: none; -webkit-touch-callout: none; -webkit-user-select: none; user-select: none;
        }
        canvas { position:fixed; top:0; left:0; width:100%; height:100%; z-index:-1; image-rendering:pixelated; }
        ::-webkit-scrollbar { width:6px; height:6px; }
        ::-webkit-scrollbar-track { background:rgba(255,255,255,0.05); border-radius:3px; }
        ::-webkit-scrollbar-thumb { background:#ff69b4; border-radius:3px; }

        /* ====================== 响应式布局 ====================== */
        @media (max-width: 768px) {
            #omega-header { font-size:1.8rem !important; letter-spacing:1.5px !important; }
            .input-group { max-width:90% !important; }
            input[type=number] { padding:12px 14px !important; font-size:1rem !important; }
            button { padding:12px 28px !important; font-size:1rem !important; }
            #progress-container { height:14px !important; }
            #status-bar, #progress-text { font-size:1rem !important; }
            #log { min-height:180px !important; font-size:0.9rem !important; padding:12px !important; }
            .safety-tip { font-size:0.85rem !important; padding:10px 12px !important; }
            .tip { font-size:0.78rem !important; }
        }
        @media (max-width: 480px) {
            #omega-header { font-size:1.5rem !important; }
            button { padding:10px 24px !important; font-size:0.95rem !important; }
            #log { min-height:150px !important; }
        }

        /* ====================== 动态风景（响应式） ====================== */
        #scene { position:relative; width:100%; height:100%; perspective:1000px; }
        #sky { position:absolute; inset:0; z-index:1; will-change:filter; background:linear-gradient(180deg, #1e3a5f 0%, #2b5a8c 15%, #ff9a8b 40%, #ffd1a3 60%, #a8edea 85%, #fed6e3 100%); animation:dayCycle 120s linear infinite; }
        @keyframes dayCycle { 0%,100% { filter:hue-rotate(0deg) brightness(1) saturate(1); } 50% { filter:hue-rotate(15deg) brightness(1.05) saturate(1.1); } }

        #distant-mountains, #mid-mountains, #foreground { position:absolute; bottom:0; left:0; width:100%; will-change:transform; opacity:0.7; }
        #distant-mountains { height:55%; background:linear-gradient(to top, #1e3a5f, #2d5a7d); transform:translateZ(-200px) scale(1.3); }
        #mid-mountains { height:60%; z-index:3; background:linear-gradient(to top, #2d5a7d, #3b82f6); transform:translateZ(-100px) scale(1.15); }
        #foreground { height:100%; z-index:4; background:linear-gradient(to top, transparent 40%, #6ee7b7 100%); transform:translateZ(0); }

        #lake { position:absolute; bottom:0; left:0; width:100%; height:35%; z-index:5; background:linear-gradient(135deg, rgba(173,216,230,0.5), rgba(255,255,255,0.3)); backdrop-filter:blur(8px); animation:ripple 12s ease-in-out infinite; clip-path:ellipse(70% 50% at 50% 100%); }
        @keyframes ripple { 0%,100% { transform:scale(1) translateY(0); } 50% { transform:scale(1.03) translateY(-4px); } }

        .cloud { position:absolute; background:#fff; border-radius:100px; opacity:0.7; filter:blur(10px); animation:drift linear infinite; will-change:transform; }
        @keyframes drift { from { transform:translateX(-300px); } to { transform:translateX(150vw); } }

        .bird { position:absolute; width:14px; height:14px; background:transparent; clip-path:polygon(50% 0%, 0% 50%, 50% 100%, 100% 50%); background:#fff; opacity:0.65; animation:birdFly 16s linear infinite; }
        @keyframes birdFly { 0% { transform:translate(-100px, 0) rotate(0deg); } 100% { transform:translate(140vw, -50px) rotate(12deg); } }

        #trigger-area { position:absolute; inset:0; cursor:default; z-index:10; }

        /* 手柄光标 */
        #gamepad-cursor {
            position:fixed; width:18px; height:18px; background:radial-gradient(circle, #ff69b4 0%, #ff1493 100%);
            border-radius:50%; box-shadow:0 0 16px #ff69b4, 0 0 24px #ff1493; pointer-events:none;
            z-index:9999; opacity:0; transition:opacity 0.3s; transform:translate(-50%, -50%);
            animation:pulseCursor 1.5s infinite;
        }
        @keyframes pulseCursor { 0%,100% { box-shadow:0 0 16px #ff69b4, 0 0 24px #ff1493; } 50% { box-shadow:0 0 24px #ff69b4, 0 0 32px #ff1493; } }

        #stone {
            position:fixed; right:18px; bottom:18px; width:28px; height:28px; z-index:11;
            background:radial-gradient(circle at 35% 35%, #ccc 0%, #999 65%, #666 100%);
            border-radius:50%; box-shadow:0 3px 10px rgba(0,0,0,0.5), inset 0 1px 3px rgba(255,255,255,0.4);
            opacity:0; transition:all 0.6s cubic-bezier(0.4, 0, 0.2, 1); cursor:pointer; pointer-events:none;
            background-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><path d="M50,10 Q30,30 20,50 Q30,70 50,85 Q70,70 80,50 Q70,30 50,10" fill="%23666" stroke="%23444" stroke-width="2"/></svg>');
            background-size:80% 80%; background-position:center; background-repeat:no-repeat;
        }
        #stone.visible { opacity:0.32; pointer-events:auto; }
        #stone.visible:hover, #stone.visible.focus { opacity:0.75; transform:scale(1.2) rotate(15deg); box-shadow:0 0 20px #ff69b4; }

        /* ====================== OMEGA 面板（响应式 + 手柄支持） ====================== */
        #omega-panel {
            position:fixed; inset:0; background:rgba(10,6,20,0.98); color:#fff;
            display:none; flex-direction:column; align-items:center; justify-content:flex-start;
            padding:3vh 5vw; backdrop-filter:blur(20px); z-index:999; overflow-y:auto;
            background-image:radial-gradient(circle at top right, rgba(255,105,180,0.18), transparent 60%), radial-gradient(circle at bottom left, rgba(100,200,255,0.15), transparent 60%);
            animation:fadeIn 0.8s ease-out;
        }
        @keyframes fadeIn { from{opacity:0; transform:scale(0.95);} to{opacity:1; transform:scale(1);} }

        #omega-header {
            width:90%; max-width:720px; text-align:center; margin:1rem 0 1.8rem;
            font-size:2.3rem; font-weight:200; letter-spacing:3px; color:transparent;
            background:linear-gradient(90deg, #ff69b4, #ff99cc, #a0f7c0, #89CFF0, #ff69b4);
            background-size:200% 100%; -webkit-background-clip:text; background-clip:text;
            animation:gradientShift 8s ease infinite; text-shadow:0 0 15px rgba(255,105,180,0.6);
        }
        @keyframes gradientShift { 0%,100%{background-position:0% 50%;} 50%{background-position:100% 50%;} }

        .heart { color:#ff1493; animation:pulse 1.8s infinite; display:inline-block; filter:drop-shadow(0 0 6px #ff1493); }
        @keyframes pulse { 0%,100%{transform:scale(1);} 50%{transform:scale(1.3);} }

        .input-group {
            margin:16px 0; width:90%; max-width:540px; position:relative;
        }
        label {
            display:block; margin-bottom:8px; color:#ffccdd; font-weight:600; font-size:0.98rem;
            text-shadow:0 0 8px rgba(255,204,221,0.6); transition:all 0.3s;
        }
        input[type=number] {
            width:100%; padding:14px 18px; border:none; border-radius:14px;
            background:rgba(255,255,255,0.15); color:#fff; font-size:1.1rem;
            backdrop-filter:blur(8px); transition:all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow:inset 0 3px 8px rgba(0,0,0,0.25), 0 0 0 2px transparent;
        }
        input[type=number]:focus, input[type=number].focus {
            outline:none; box-shadow:0 0 0 3px #ff69b4, inset 0 3px 8px rgba(0,0,0,0.25);
            background:rgba(255,255,255,0.25); transform:scale(1.02);
        }

        .safety-tip {
            margin:12px 0; padding:12px 16px; background:rgba(255,193,7,0.15); border-left:4px solid #ffc107;
            border-radius:8px; font-size:0.9rem; color:#fff; line-height:1.5; backdrop-filter:blur(4px); animation:slideIn 0.6s ease-out;
        }
        @keyframes slideIn { from{transform:translateX(-30px); opacity:0;} to{transform:translateX(0); opacity:1;} }

        #progress-container {
            margin:22px 0; width:90%; max-width:540px; height:18px;
            background:rgba(255,255,255,0.12); border-radius:9px; overflow:hidden; position:relative; box-shadow:inset 0 3px 8px rgba(0,0,0,0.3);
        }
        #progress-bar {
            height:100%; width:0%; background:linear-gradient(90deg, #ff1493, #ff69b4, #ff8fab);
            border-radius:9px; transition:width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            position:relative; overflow:hidden; box-shadow:0 0 12px rgba(255,105,180,0.6);
        }
        #progress-bar::before {
            content:''; position:absolute; inset:0;
            background:linear-gradient(45deg, transparent 30%, rgba(255,255,255,0.4) 50%, transparent 70%);
            animation:shimmer 1.8s infinite;
        }
        @keyframes shimmer { 0% { transform:translateX(-100%); } 100% { transform:translateX(100%); } }

        #progress-text {
            text-align:center; margin-top:8px; color:#a0f7c0; font-weight:700; font-size:1.15rem;
            text-shadow:0 0 10px rgba(160,247,192,0.7); animation:glow 2s infinite alternate;
        }
        @keyframes glow { from{text-shadow:0 0 10px rgba(160,247,192,0.7);} to{text-shadow:0 0 20px rgba(160,247,192,1);} }

        #status-bar {
            margin:14px 0; width:90%; max-width:540px; text-align:center;
            color:#a0f7c0; font-weight:600; font-size:1.15rem;
            text-shadow:0 0 10px rgba(160,247,192,0.6); padding:10px; background:rgba(0,0,0,0.2); border-radius:10px;
        }

        #log {
            width:90%; max-width:720px; min-height:240px; background:rgba(15,15,22,0.9);
            border-radius:14px; padding:16px; overflow-y:auto; font-family:'Courier New', monospace;
            color:#ffeb3b; font-size:0.98rem; line-height:1.6; border:1px solid rgba(255,235,59,0.25);
            box-shadow:0 6px 16px rgba(0,0,0,0.4); margin-bottom:20px;
        }

        button {
            margin:18px auto; padding:14px 36px; border:none; border-radius:50px;
            background:linear-gradient(45deg, #ff1493, #ff69b4, #ff8fab); color:#fff;
            font-weight:700; font-size:1.1rem; cursor:pointer; letter-spacing:1.5px;
            box-shadow:0 8px 20px rgba(255,20,147,0.5);
            transition:all 0.4s cubic-bezier(0.4, 0, 0.2, 1); position:relative; overflow:hidden;
        }
        button::before {
            content:''; position:absolute; inset:0; background:linear-gradient(45deg, transparent, rgba(255,255,255,0.4), transparent);
            transform:translateX(-100%); transition:0.7s;
        }
        button:hover::before, button.focus::before { transform:translateX(100%); }
        button:hover, button.focus { transform:translateY(-4px); box-shadow:0 12px 28px rgba(255,20,147,0.7); }
        button:disabled { opacity:0.6; cursor:not-allowed; transform:none; }

        .tip { font-size:0.82rem; color:#ccc; text-align:center; margin-top:10px; font-style:italic; }

        .midway-tip {
            position:fixed; top:50%; left:50%; transform:translate(-50%, -50%) scale(0);
            background:rgba(0,0,0,0.85); color:#ff69b4; padding:16px 24px; border-radius:16px;
            font-size:1.2rem; font-weight:600; text-align:center; z-index:1000;
            backdrop-filter:blur(12px); box-shadow:0 8px 32px rgba(255,105,180,0.5);
            animation:popIn 0.6s cubic-bezier(0.4, 0, 1, 1) forwards, popOut 0.6s 2.4s cubic-bezier(0.4, 0, 0.2, 1) forwards;
        }
        @keyframes popIn { to{transform:translate(-50%, -50%) scale(1); opacity:1;} }
        @keyframes popOut { to{transform:translate(-50%, -50%) scale(0); opacity:0;} }

        #hint {
            position:fixed; right:22px; bottom:62px; color:#fff; font-size:0.85rem;
            opacity:0; pointer-events:none; transition:opacity 0.6s;
            text-shadow:0 0 8px #ff69b4; animation:breath 3s infinite;
        }
        @keyframes breath { 0%,100%{opacity:0;} 50%{opacity:1;} }
        #hint.visible { opacity:1; animation:none; }

        .super-boost { color:#ff1493; font-weight:900; font-size:1.1rem; animation:rainbow 2s infinite, shake 0.5s; text-shadow:0 0 10px #ff1493, 0 0 20px #ff69b4; }
        @keyframes rainbow { 0% { color:#ff1493; } 20% { color:#ff69b4; } 40% { color:#ff8fab; } 60% { color:#a0f7c0; } 80% { color:#89CFF0; } 100% { color:#ff1493; } }
        @keyframes shake { 0%,100% { transform:translateX(0); } 25% { transform:translateX(-3px); } 75% { transform:translateX(3px); } }

        /* 手柄焦点样式 */
        .focus { outline:3px solid #ff69b4 !important; outline-offset:2px; box-shadow:0 0 20px rgba(255,105,180,0.8) !important; }
    </style>
</head>
<body>

    <canvas id="canvas"></canvas>
    <div id="gamepad-cursor"></div>

    <div id="scene">
        <div id="sky"></div>
        <div id="distant-mountains"></div>
        <div id="mid-mountains"></div>
        <div id="foreground"></div>
        <div id="lake"></div>
        <div id="trigger-area"></div>
    </div>

    <div id="stone"></div>
    <div id="hint">点击小石 <span class="heart">Heart</span> 10 次…</div>

    <!-- ====================== OMEGA 控制面板 ====================== -->
    <div id="omega-panel">
        <div id="omega-header">
            <span class="heart">Heart</span> L O V E L Y  P L E A S U R E  L O O P <span class="heart">Heart</span> V3.∞
        </div>

        <div class="safety-tip">
            Warning: 请确保使用润滑剂 · 保持放松 · 随时可停止 · 安全第一
        </div>
        <div class="safety-tip">
            Info: 建议从短时间开始，逐步适应 · 听从身体信号
        </div>

        <div class="input-group">
            <label>玩具插入长度 (cm，≤150.0)</label>
            <input type="number" id="toy-length" step="0.1" min="0" max="150" placeholder="推荐 12.0 ~ 28.0" tabindex="1">
        </div>
        <div class="input-group">
            <label>玩具最大直径 (cm，≤5.0)</label>
            <input type="number" id="toy-diameter" step="0.1" min="0" max="5" placeholder="推荐 2.5 ~ 4.2" tabindex="2">
        </div>
        <div class="input-group">
            <label>总动作次数（默认10，自动取偶数）</label>
            <input type="number" id="total-count" min="2" placeholder="留空 = 10，越大越持久" tabindex="3">
            <div class="tip">每次“插入+拔出”为2次动作 · 建议首次不超过20</div>
        </div>

        <button id="start-btn" tabindex="4">开始温柔仪式</button>

        <div id="progress-container">
            <div id="progress-bar"></div>
        </div>
        <div id="progress-text">0.0%</div>

        <div id="status-bar"></div>
        <pre id="log"></pre>

        <div class="tip" style="margin-top:20px;">
            温柔以待，慢即是美 <span class="heart">Heart</span> 每一次动作都值得期待
        </div>
    </div>

<script>
// ====================== 响应式 + 手柄支持核心 ======================
const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
const cursor = document.getElementById('gamepad-cursor');
let gamepadIndex = null;
let cursorX = 0, cursorY = 0;
let currentFocus = null;
let isGamepadConnected = false;

// 手柄连接检测
window.addEventListener('gamepadconnected', (e) => {
    gamepadIndex = e.gamepad.index;
    isGamepadConnected = true;
    cursor.style.opacity = '1';
    document.body.style.cursor = 'none';
    requestAnimationFrame(gamepadLoop);
    showGamepadHint();
});

window.addEventListener('gamepaddisconnected', () => {
    gamepadIndex = null;
    isGamepadConnected = false;
    cursor.style.opacity = '0';
    document.body.style.cursor = 'auto';
    hideGamepadHint();
});

// 手柄循环
function gamepadLoop() {
    if (!isGamepadConnected) return;
    const gp = navigator.getGamepads()[gamepadIndex];
    if (!gp) return;

    // 左摇杆移动光标
    const axisX = gp.axes[0];
    const axisY = gp.axes[1];
    if (Math.abs(axisX) > 0.2 || Math.abs(axisY) > 0.2) {
        cursorX += axisX * 12;
        cursorY += axisY * 12;
        cursorX = Math.max(0, Math.min(window.innerWidth, cursorX));
        cursorY = Math.max(0, Math.min(window.innerHeight, cursorY));
        cursor.style.left = cursorX + 'px';
        cursor.style.top = cursorY + 'px';
    }

    // A键点击
    if (gp.buttons[0].pressed) {
        const el = document.elementFromPoint(cursorX, cursorY);
        if (el && (el.tagName === 'INPUT' || el.tagName === 'BUTTON' || el.id === 'stone')) {
            el.click();
            el.focus();
            setFocus(el);
        }
    }

    // 方向键切换焦点
    if (gp.buttons[12].pressed) moveFocus('up');
    if (gp.buttons[13].pressed) moveFocus('down');
    if (gp.buttons[14].pressed) moveFocus('left');
    if (gp.buttons[15].pressed) moveFocus('right');

    requestAnimationFrame(gamepadLoop);
}

function moveFocus(dir) {
    const focusables = Array.from(document.querySelectorAll('input, button, #stone.visible'));
    if (focusables.length === 0) return;
    let idx = focusables.indexOf(currentFocus);
    if (idx === -1) idx = 0;
    else idx = (idx + (dir === 'down' || dir === 'right' ? 1 : -1) + focusables.length) % focusables.length;
    const next = focusables[idx];
    next.focus();
    setFocus(next);
    cursorX = next.getBoundingClientRect().left + next.offsetWidth / 2;
    cursorY = next.getBoundingClientRect().top + next.offsetHeight / 2;
    cursor.style.left = cursorX + 'px';
    cursor.style.top = cursorY + 'px';
}

function setFocus(el) {
    if (currentFocus) currentFocus.classList.remove('focus');
    currentFocus = el;
    el.classList.add('focus');
}

// 手柄提示
function showGamepadHint() {
    const hint = document.createElement('div');
    hint.id = 'gamepad-hint';
    hint.style.cssText = 'position:fixed; top:20px; left:50%; transform:translateX(-50%); background:rgba(0,0,0,0.8); color:#ff69b4; padding:8px 16px; border-radius:8px; font-size:0.9rem; z-index:10000; animation:popIn 0.5s;';
    hint.textContent = '手柄已连接：左摇杆移动，A键确认';
    document.body.appendChild(hint);
    setTimeout(() => hint.remove(), 5000);
}
function hideGamepadHint() {
    const hint = document.getElementById('gamepad-hint');
    if (hint) hint.remove();
}

// ====================== 其余逻辑（保持不变） ======================
// [此处粘贴之前完整的 OMEGA 逻辑代码，包括动态背景、触发逻辑、会话逻辑等]
// 为节省篇幅，这里仅展示关键部分，完整代码请参考上一个版本

// 动态背景、触发逻辑、OMEGA 核心逻辑保持不变
// 仅添加手柄支持和响应式优化

// 示例：保持之前的 startSession, updateProgress 等函数
// ...（完整代码同上一个版本）

// 页面加载后初始化
window.addEventListener('load', () => {
    if (isMobile) {
        document.body.classList.add('mobile');
    }
    // 其他初始化
});
</script>
</body>
</html>
